import{a as C,t as F,c as ye}from"./CYx-rXx-.js";import{p as te,t as xe,g as u,r as g,a as re,s as l,u as Y,f as Z,c as B,e as z,b as v,d as he}from"./BuHArsY0.js";import{i as $}from"./BRjXdOdS.js";import{e as ae,i as ne}from"./BQh-kVlY.js";import{b as be,p as D}from"./BWkvJX5E.js";import{o as ge}from"./3z7p6Gb1.js";import{b as ee}from"./iVnMTv6p.js";import{d as Ie}from"./rKodDvQ3.js";import{s as we}from"./CqptiWKP.js";import{g as ke,a as Ue,R as Se,G as Pe}from"./B5Nd_4hB.js";import{M as Be}from"./CiTEeDlS.js";function De(r){var t=new f(r),i=t.readChunk();if(i.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+i.id+"'";for(var c=Te(i.data),s=[],d=0;!t.eof()&&d<c.numTracks;d++){var e=t.readChunk();if(e.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+e.id+"'";var m=Ee(e.data);s.push(m)}return{header:c,tracks:s}}function Te(r){var t=new f(r),i=t.readUInt16(),c=t.readUInt16(),s={format:i,numTracks:c},d=t.readUInt16();return d&32768?(s.framesPerSecond=256-(d>>8),s.ticksPerFrame=d&255):s.ticksPerBeat=d,s}function Ee(r){for(var t=new f(r),i=[];!t.eof();){var c=d();i.push(c)}return i;var s;function d(){var e={};e.deltaTime=t.readVarInt();var m=t.readUInt8();if((m&240)===240)if(m===255){e.meta=!0;var I=t.readUInt8(),a=t.readVarInt();switch(I){case 0:if(e.type="sequenceNumber",a!==2)throw"Expected length for sequenceNumber event is 2, got "+a;return e.number=t.readUInt16(),e;case 1:return e.type="text",e.text=t.readString(a),e;case 2:return e.type="copyrightNotice",e.text=t.readString(a),e;case 3:return e.type="trackName",e.text=t.readString(a),e;case 4:return e.type="instrumentName",e.text=t.readString(a),e;case 5:return e.type="lyrics",e.text=t.readString(a),e;case 6:return e.type="marker",e.text=t.readString(a),e;case 7:return e.type="cuePoint",e.text=t.readString(a),e;case 32:if(e.type="channelPrefix",a!=1)throw"Expected length for channelPrefix event is 1, got "+a;return e.channel=t.readUInt8(),e;case 33:if(e.type="portPrefix",a!=1)throw"Expected length for portPrefix event is 1, got "+a;return e.port=t.readUInt8(),e;case 47:if(e.type="endOfTrack",a!=0)throw"Expected length for endOfTrack event is 0, got "+a;return e;case 81:if(e.type="setTempo",a!=3)throw"Expected length for setTempo event is 3, got "+a;return e.microsecondsPerBeat=t.readUInt24(),e;case 84:if(e.type="smpteOffset",a!=5)throw"Expected length for smpteOffset event is 5, got "+a;var w=t.readUInt8(),T={0:24,32:25,64:29,96:30};return e.frameRate=T[w&96],e.hour=w&31,e.min=t.readUInt8(),e.sec=t.readUInt8(),e.frame=t.readUInt8(),e.subFrame=t.readUInt8(),e;case 88:if(e.type="timeSignature",a!=2&&a!=4)throw"Expected length for timeSignature event is 4 or 2, got "+a;return e.numerator=t.readUInt8(),e.denominator=1<<t.readUInt8(),a===4?(e.metronome=t.readUInt8(),e.thirtyseconds=t.readUInt8()):(e.metronome=36,e.thirtyseconds=8),e;case 89:if(e.type="keySignature",a!=2)throw"Expected length for keySignature event is 2, got "+a;return e.key=t.readInt8(),e.scale=t.readUInt8(),e;case 127:return e.type="sequencerSpecific",e.data=t.readBytes(a),e;default:return e.type="unknownMeta",e.data=t.readBytes(a),e.metatypeByte=I,e}}else if(m==240){e.type="sysEx";var a=t.readVarInt();return e.data=t.readBytes(a),e}else if(m==247){e.type="endSysEx";var a=t.readVarInt();return e.data=t.readBytes(a),e}else throw"Unrecognised MIDI event type byte: "+m;else{var p;if(m&128)p=t.readUInt8(),s=m;else{if(s===null)throw"Running status byte encountered before status byte";p=m,m=s,e.running=!0}var k=m>>4;switch(e.channel=m&15,k){case 8:return e.type="noteOff",e.noteNumber=p,e.velocity=t.readUInt8(),e;case 9:var E=t.readUInt8();return e.type=E===0?"noteOff":"noteOn",e.noteNumber=p,e.velocity=E,E===0&&(e.byte9=!0),e;case 10:return e.type="noteAftertouch",e.noteNumber=p,e.amount=t.readUInt8(),e;case 11:return e.type="controller",e.controllerType=p,e.value=t.readUInt8(),e;case 12:return e.type="programChange",e.programNumber=p,e;case 13:return e.type="channelAftertouch",e.amount=p,e;case 14:return e.type="pitchBend",e.value=p+(t.readUInt8()<<7)-8192,e;default:throw"Unrecognised MIDI event type: "+k}}}}function f(r){this.buffer=r,this.bufferLen=this.buffer.length,this.pos=0}f.prototype.eof=function(){return this.pos>=this.bufferLen};f.prototype.readUInt8=function(){var r=this.buffer[this.pos];return this.pos+=1,r};f.prototype.readInt8=function(){var r=this.readUInt8();return r&128?r-256:r};f.prototype.readUInt16=function(){var r=this.readUInt8(),t=this.readUInt8();return(r<<8)+t};f.prototype.readInt16=function(){var r=this.readUInt16();return r&32768?r-65536:r};f.prototype.readUInt24=function(){var r=this.readUInt8(),t=this.readUInt8(),i=this.readUInt8();return(r<<16)+(t<<8)+i};f.prototype.readInt24=function(){var r=this.readUInt24();return r&8388608?r-16777216:r};f.prototype.readUInt32=function(){var r=this.readUInt8(),t=this.readUInt8(),i=this.readUInt8(),c=this.readUInt8();return(r<<24)+(t<<16)+(i<<8)+c};f.prototype.readBytes=function(r){var t=this.buffer.slice(this.pos,this.pos+r);return this.pos+=r,t};f.prototype.readString=function(r){var t=this.readBytes(r);return String.fromCharCode.apply(null,t)};f.prototype.readVarInt=function(){for(var r=0;!this.eof();){var t=this.readUInt8();if(t&128)r+=t&127,r<<=7;else return r+t}return r};f.prototype.readChunk=function(){var r=this.readString(4),t=this.readUInt32(),i=this.readBytes(t);return{id:r,length:t,data:i}};var Me=De,Ce=Me,Ne=F("<div></div>"),Re=F('<button class=" grid h-full w-full grid-cols-16 flex-row rounded border-4 border-gray-500 hover:ring-blue-500"></button>');function Fe(r,t){te(t,!0),be(t,"active",11,!1);const i=D([]);for(const[s,d]of t.pattern_array.entries())d?s%16<=3||8<=s%16&&s%16<=11?i.push("bg-green-600"):i.push("bg-green-700"):s%16<=3||8<=s%16&&s%16<=11?i.push("bg-gray-300"):i.push("bg-gray-400");var c=Re();c.__mouseup=function(...s){var d;(d=t.onmouseup)==null||d.apply(this,s)},ae(c,21,()=>i,ne,(s,d)=>{var e=Ne();xe(()=>we(e,`h-full ${u(d)??""} border border-black`)),C(s,e)}),g(c),C(r,c),re()}Ie(["mouseup"]);const He=[{midi_src:"2_Custom2.mid",audio_src:"2_Custom2.wav",instrument_type:"Drum"},{midi_src:"2_Custom3.mid",audio_src:"2_Custom3.wav",instrument_type:"Drum"},{midi_src:"2_Elektro1.mid",audio_src:"2_Elektro 1.wav",instrument_type:"Drum"},{midi_src:"2_Elektro2.mid",audio_src:"2_Elektro 2.wav",instrument_type:"Drum"},{midi_src:"2_HipHop1.mid",audio_src:"2_Hip Hop 1.wav",instrument_type:"Drum"},{midi_src:"2_HipHop2.mid",audio_src:"2_Hip Hop 2.wav",instrument_type:"Drum"},{midi_src:"2_Techno_1.mid",audio_src:"2_Techno 1.wav",instrument_type:"Drum"},{midi_src:"2_Techno_2.mid",audio_src:"2_Techno 2.wav",instrument_type:"Drum"},{midi_src:"3_AmenBreaks.mid",audio_src:"3_Amen Breaks.wav",instrument_type:"Drum"},{midi_src:"3_Custom1.mid",audio_src:"3_Custom 1.wav",instrument_type:"Drum"},{midi_src:"3_Rock1.mid",audio_src:"3_Rock 1.wav",instrument_type:"Drum"},{midi_src:"3_Rumba.mid",audio_src:"3_Rumba.wav",instrument_type:"Drum"},{midi_src:"3_SiberianNights.mid",audio_src:"3_Siberian Nights.wav",instrument_type:"Drum"},{midi_src:"3_SonClave.mid",audio_src:"3_Son Clave.wav",instrument_type:"Drum"},{midi_src:"4_FunkyDrummer.mid",audio_src:"4_Funky Drummer.wav",instrument_type:"Drum"},{midi_src:"4_House1.mid",audio_src:"4_House 1.wav",instrument_type:"Drum"},{midi_src:"4_House2.mid",audio_src:"4_House 2.wav",instrument_type:"Drum"},{midi_src:"4_Rock2.mid",audio_src:"4_Rock 2.wav",instrument_type:"Drum"},{midi_src:"bass_1.mid",audio_src:"bass_1.wav",instrument_type:"Bass"},{midi_src:"bass_2.mid",audio_src:"bass_2.wav",instrument_type:"Bass"},{midi_src:"bass_3.mid",audio_src:"bass_3.wav",instrument_type:"Bass"},{midi_src:"piano_1.mid",audio_src:"piano_1.wav",instrument_type:"Piano"},{midi_src:"piano_2.mid",audio_src:"piano_2.wav",instrument_type:"Piano"},{midi_src:"piano_3.mid",audio_src:"piano_3.wav",instrument_type:"Piano"},{midi_src:"piano_4.mid",audio_src:"piano_4.wav",instrument_type:"Piano"}];var Oe=F('<div class="h-full w-full basis-1/6"><!></div>'),Ge=F('<div class="absolute left-0 top-0"><!></div>'),Ae=F('<div class="flex size-full justify-between gap-4 rounded-2xl border-x-[7px] border-b-[14px] border-t-[7px] border-b-gray-600 border-l-gray-200 border-r-gray-400 border-t-gray-400 bg-[#d1d5db] p-3 shadow-2xl lg:border-x-[10px] lg:border-b-[20px] lg:border-t-[10px] lg:p-10"><div class="flex basis-9/12 flex-col items-center justify-evenly"><!></div> <div class="flex basis-1/6 flex-col items-center"><div class="h-5/6"><!></div></div> <!></div> <div class="absolute left-6 top-0 m-3 mt-10"><!></div>',1);function Ze(r,t){te(t,!0);const i=D([]);let c=v(0),s=v(-1),d=v(!1),e=v("4_Rock 2.wav"),m=v(!1),I=v(!0),a=v(!1),w=v(!1),T=v(0),p=v(!0),k=v(0),E=0;const se=async(o,_)=>{const y=await(await fetch(ee+"/midis/"+o)).arrayBuffer(),N=new Uint8Array(y),Q=Ce(N),x={};let M=[],R=0,X=0;for(const n of Q.tracks[0])R+=n.deltaTime,n.type==="noteOn"?(n.noteNumber in x||(x[n.noteNumber]=[],X++),x[n.noteNumber].push(R)):n.type==="noteOff"&&x[n.noteNumber].push(R);let U=[],H=1e4,q=0;for(const[,n]of Object.entries(x)){let P=[];for(let h=0;h<n.length;h+=2){let G=n[h+1]-n[h];H=Math.min(H,G),q=Math.max(q,n[h+1]),P.push({start:n[h],len:G})}U.push(P)}let S=q/16;const O=[6,12,24,48,96];if(!O.includes(S)){for(let n=0;n<O.length;n++)if(S<=O[n]){S=O[n];break}}H%S!==0&&(S=H),U=U.reverse(),M=new Array(16*X).fill(!1);for(let n=0;n<U.length;n++)for(let P=0;P<U[n].length;P++){let h=n*16+U[n][P].start/S,G=h+U[n][P].len/S;for(let L=h;L<G;L++)M[L]=!0}E=Math.max(E,M.length),i.push({pattern:M,selected:!1,index:_})};ge(()=>{let o;switch(t.difficulty){case 1:{o="Piano";break}case 2:{o="Bass";break}default:o="Drum"}const _=ke(He.filter(b=>b.instrument_type===o),3);l(c,D(Ue(_))),l(e,D(_[u(c)].audio_src));for(const[b,y]of _.entries())se(y.midi_src,b);l(d,!0),de(),l(I,!1),Y(k)});function ie(){l(w,u(c)===u(s)),l(p,!1),l(I,!0),l(m,!0),l(a,!1)}function oe(){const o=ue();t.handleNextRound(o),l(m,!1)}function ue(){let o=0;return u(w)&&(o+=1e4,o+=Math.max(-236*u(T)+8e3,2e3*.9^u(T)),o+=Math.max(-1234*u(k)+5e3,2e3*.9^u(k))),o}function de(){setInterval(()=>{u(p)&&Y(T)},1e3)}var W=Ae(),A=Z(W),V=B(A),ce=B(V);{var me=o=>{var _=ye(),b=Z(_);ae(b,17,()=>i,ne,(y,N,Q)=>{var x=Oe(),M=B(x);Fe(M,{get pattern_array(){return u(N).pattern},onmouseup:()=>ie(),get active(){return u(N).selected},set active(R){u(N).selected=R}}),g(x),C(y,x)}),C(o,_)};$(ce,o=>{u(d)&&o(me)})}g(V);var j=z(V,2),J=B(j),fe=B(J),le=he(()=>ee+"/audios/pattern_sounds/"+u(e));Be(fe,{get repeats(){return u(k)},get time(){return u(T)},get trackSource(){return u(le)},get volume(){return t.volume},get trackPaused(){return u(I)},set trackPaused(o){l(I,D(o))}}),g(J),g(j);var pe=z(j,2);{var _e=o=>{var _=Ge(),b=B(_);Pe(b,{onclick:oe,get GIFButtonTextSuccess(){return t.GIFButtonTextSuccess},get GIFButtonTextFailure(){return t.GIFButtonTextFailure},get volume(){return t.volume},get success(){return u(w)},set success(y){l(w,D(y))},get gifSoundPaused(){return u(a)},set gifSoundPaused(y){l(a,D(y))}}),g(_),C(o,_)};$(pe,o=>{u(m)&&o(_e)})}g(A);var K=z(A,2),ve=B(K);Se(ve,{}),g(K),C(r,W),re()}export{Ze as P};
