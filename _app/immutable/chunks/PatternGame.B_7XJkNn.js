import"./disclose-version.Bg9kRutz.js";import{p as X,t as L,g as d,r as x,a as Y,b as l,u as W,f as z,c as b,s as R,d as _,e as le}from"./runtime.BFcw_75_.js";import{a as k,t as P,c as pe}from"./template.B-ObnXcP.js";import{i as J}from"./if.BqcDyKEL.js";import{e as Z,i as $}from"./each.CJS3MHhM.js";import{b as ve,p as I}from"./props.073RLZyP.js";import{o as _e}from"./index-client.Bxs-rmcU.js";import{b as K}from"./paths.DCwD0S_x.js";import{d as ye}from"./render.DJfPp5iK.js";import{a as Q,B as xe}from"./Button3d.SKqD834h.js";import{a as he,b as be,G as Ie}from"./GIF.D1-RCoXJ.js";import{M as ge}from"./MusicControl.DTt4gZau.js";import{p as we}from"./patternLevels.BRSVCcvJ.js";import{R as Ue}from"./ResetButton.DVLzMa4s.js";function ke(r){var t=new m(r),o=t.readChunk();if(o.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+o.id+"'";for(var c=Se(o.data),a=[],s=0;!t.eof()&&s<c.numTracks;s++){var e=t.readChunk();if(e.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+e.id+"'";var u=Be(e.data);a.push(u)}return{header:c,tracks:a}}function Se(r){var t=new m(r),o=t.readUInt16(),c=t.readUInt16(),a={format:o,numTracks:c},s=t.readUInt16();return s&32768?(a.framesPerSecond=256-(s>>8),a.ticksPerFrame=s&255):a.ticksPerBeat=s,a}function Be(r){for(var t=new m(r),o=[];!t.eof();){var c=s();o.push(c)}return o;var a;function s(){var e={};e.deltaTime=t.readVarInt();var u=t.readUInt8();if((u&240)===240)if(u===255){e.meta=!0;var g=t.readUInt8(),n=t.readVarInt();switch(g){case 0:if(e.type="sequenceNumber",n!==2)throw"Expected length for sequenceNumber event is 2, got "+n;return e.number=t.readUInt16(),e;case 1:return e.type="text",e.text=t.readString(n),e;case 2:return e.type="copyrightNotice",e.text=t.readString(n),e;case 3:return e.type="trackName",e.text=t.readString(n),e;case 4:return e.type="instrumentName",e.text=t.readString(n),e;case 5:return e.type="lyrics",e.text=t.readString(n),e;case 6:return e.type="marker",e.text=t.readString(n),e;case 7:return e.type="cuePoint",e.text=t.readString(n),e;case 32:if(e.type="channelPrefix",n!=1)throw"Expected length for channelPrefix event is 1, got "+n;return e.channel=t.readUInt8(),e;case 33:if(e.type="portPrefix",n!=1)throw"Expected length for portPrefix event is 1, got "+n;return e.port=t.readUInt8(),e;case 47:if(e.type="endOfTrack",n!=0)throw"Expected length for endOfTrack event is 0, got "+n;return e;case 81:if(e.type="setTempo",n!=3)throw"Expected length for setTempo event is 3, got "+n;return e.microsecondsPerBeat=t.readUInt24(),e;case 84:if(e.type="smpteOffset",n!=5)throw"Expected length for smpteOffset event is 5, got "+n;var w=t.readUInt8(),E={0:24,32:25,64:29,96:30};return e.frameRate=E[w&96],e.hour=w&31,e.min=t.readUInt8(),e.sec=t.readUInt8(),e.frame=t.readUInt8(),e.subFrame=t.readUInt8(),e;case 88:if(e.type="timeSignature",n!=2&&n!=4)throw"Expected length for timeSignature event is 4 or 2, got "+n;return e.numerator=t.readUInt8(),e.denominator=1<<t.readUInt8(),n===4?(e.metronome=t.readUInt8(),e.thirtyseconds=t.readUInt8()):(e.metronome=36,e.thirtyseconds=8),e;case 89:if(e.type="keySignature",n!=2)throw"Expected length for keySignature event is 2, got "+n;return e.key=t.readInt8(),e.scale=t.readUInt8(),e;case 127:return e.type="sequencerSpecific",e.data=t.readBytes(n),e;default:return e.type="unknownMeta",e.data=t.readBytes(n),e.metatypeByte=g,e}}else if(u==240){e.type="sysEx";var n=t.readVarInt();return e.data=t.readBytes(n),e}else if(u==247){e.type="endSysEx";var n=t.readVarInt();return e.data=t.readBytes(n),e}else throw"Unrecognised MIDI event type byte: "+u;else{var p;if(u&128)p=t.readUInt8(),a=u;else{if(a===null)throw"Running status byte encountered before status byte";p=u,u=a,e.running=!0}var C=u>>4;switch(e.channel=u&15,C){case 8:return e.type="noteOff",e.noteNumber=p,e.velocity=t.readUInt8(),e;case 9:var S=t.readUInt8();return e.type=S===0?"noteOff":"noteOn",e.noteNumber=p,e.velocity=S,S===0&&(e.byte9=!0),e;case 10:return e.type="noteAftertouch",e.noteNumber=p,e.amount=t.readUInt8(),e;case 11:return e.type="controller",e.controllerType=p,e.value=t.readUInt8(),e;case 12:return e.type="programChange",e.programNumber=p,e;case 13:return e.type="channelAftertouch",e.amount=p,e;case 14:return e.type="pitchBend",e.value=p+(t.readUInt8()<<7)-8192,e;default:throw"Unrecognised MIDI event type: "+C}}}}function m(r){this.buffer=r,this.bufferLen=this.buffer.length,this.pos=0}m.prototype.eof=function(){return this.pos>=this.bufferLen};m.prototype.readUInt8=function(){var r=this.buffer[this.pos];return this.pos+=1,r};m.prototype.readInt8=function(){var r=this.readUInt8();return r&128?r-256:r};m.prototype.readUInt16=function(){var r=this.readUInt8(),t=this.readUInt8();return(r<<8)+t};m.prototype.readInt16=function(){var r=this.readUInt16();return r&32768?r-65536:r};m.prototype.readUInt24=function(){var r=this.readUInt8(),t=this.readUInt8(),o=this.readUInt8();return(r<<16)+(t<<8)+o};m.prototype.readInt24=function(){var r=this.readUInt24();return r&8388608?r-16777216:r};m.prototype.readUInt32=function(){var r=this.readUInt8(),t=this.readUInt8(),o=this.readUInt8(),c=this.readUInt8();return(r<<24)+(t<<16)+(o<<8)+c};m.prototype.readBytes=function(r){var t=this.buffer.slice(this.pos,this.pos+r);return this.pos+=r,t};m.prototype.readString=function(r){var t=this.readBytes(r);return String.fromCharCode.apply(null,t)};m.prototype.readVarInt=function(){for(var r=0;!this.eof();){var t=this.readUInt8();if(t&128)r+=t&127,r<<=7;else return r+t}return r};m.prototype.readChunk=function(){var r=this.readString(4),t=this.readUInt32(),o=this.readBytes(t);return{id:r,length:t,data:o}};var Pe=ke,Te=Pe,Ee=P("<div></div>"),Ce=P("<button></button>");function Fe(r,t){X(t,!0);let o=ve(t,"active",11,!1);const c=I([]);for(const[s,e]of t.pattern_array.entries())e?s%16<=3||8<=s%16&&s%16<=11?c.push("bg-green-600"):c.push("bg-green-700"):s%16<=3||8<=s%16&&s%16<=11?c.push("bg-gray-300"):c.push("bg-gray-400");var a=Ce();a.__mouseup=function(...s){var e;(e=t.onmouseup)==null||e.apply(this,s)},Z(a,21,()=>c,$,(s,e)=>{var u=Ee();L(()=>Q(u,`h-full ${d(e)??""} border border-black`)),k(s,u)}),x(a),L(()=>Q(a,` grid h-full w-full grid-cols-16 flex-row border-4 ${(o()?"border-blue-600 shadow-2xl shadow-blue-600 ":"border-gray-500")??""} rounded`)),k(r,a),Y()}ye(["mouseup"]);const Re=[{midi_src:"2_Custom2.mid",audio_src:"2_Custom2.wav",instrument_type:"drum",n_instruments:2},{midi_src:"2_Custom3.mid",audio_src:"2_Custom3.wav",instrument_type:"drum",n_instruments:2},{midi_src:"2_Elektro1.mid",audio_src:"2_Elektro 1.wav",instrument_type:"drum",n_instruments:2},{midi_src:"2_Elektro2.mid",audio_src:"2_Elektro 2.wav",instrument_type:"drum",n_instruments:2},{midi_src:"2_HipHop1.mid",audio_src:"2_Hip Hop 1.wav",instrument_type:"drum",n_instruments:2},{midi_src:"2_HipHop2.mid",audio_src:"2_Hip Hop 2.wav",instrument_type:"drum",n_instruments:2},{midi_src:"2_Techno_1.mid",audio_src:"2_Techno 1.wav",instrument_type:"drum",n_instruments:2},{midi_src:"2_Techno_2.mid",audio_src:"2_Techno 2.wav",instrument_type:"drum",n_instruments:2},{midi_src:"3_AmenBreaks.mid",audio_src:"3_Amen Breaks.wav",instrument_type:"drum",n_instruments:3},{midi_src:"3_Custom1.mid",audio_src:"3_Custom 1.wav",instrument_type:"drum",n_instruments:3},{midi_src:"3_Rock1.mid",audio_src:"3_Rock 1.wav",instrument_type:"drum",n_instruments:3},{midi_src:"3_Rumba.mid",audio_src:"3_Rumba.wav",instrument_type:"drum",n_instruments:3},{midi_src:"3_SiberianNights.mid",audio_src:"3_Siberian Nights.wav",instrument_type:"drum",n_instruments:3},{midi_src:"3_SonClave.mid",audio_src:"3_Son Clave.wav",instrument_type:"drum",n_instruments:3},{midi_src:"4_FunkyDrummer.mid",audio_src:"4_Funky Drummer.wav",instrument_type:"drum",n_instruments:3},{midi_src:"4_House1.mid",audio_src:"4_House 1.wav",instrument_type:"drum",n_instruments:4},{midi_src:"4_House2.mid",audio_src:"4_House 2.wav",instrument_type:"drum",n_instruments:4},{midi_src:"4_Rock2.mid",audio_src:"4_Rock 2.wav",instrument_type:"drum",n_instruments:4}];var Me=P('<div class="h-full w-full basis-1/6"><!></div>'),Ne=P('<p class="px-6 py-3">Raten</p>'),He=P('<div class="absolute left-0 top-0"><!></div>'),De=P('<div class="flex h-full w-full flex-col items-center justify-center bg-blue-300"><div class="bg-s h-11/12 border-12 ml-2 flex w-11/12 flex-row justify-evenly rounded-2xl border-8 bg-gray-600 p-5"><div class="flex basis-9/12 flex-col items-center justify-evenly"><!></div> <div class="flex basis-1/6 flex-col items-center"><div class="h-5/6"><!></div> <!></div></div> <!></div> <div class="absolute left-3 top-0 m-2 mt-4"><!></div>',1);function Ze(r,t){X(t,!0);const o=I([]);let c=_(0),a=_(-1),s=_(!1),e=_("4_Rock 2.wav"),u=_(!1),g=_(!0),n=_(!1),w=_(!1),E=_(0),p=_(!0),C=0,S=_(0);const ee=async(i,f)=>{const v=await(await fetch(K+"/midis/"+i)).arrayBuffer(),h=new Uint8Array(v),j=Te(h),T=24,B={},F=[];let q=0;for(const U of j.tracks[0])q+=U.deltaTime,U.type==="noteOn"&&(U.noteNumber in B||(B[U.noteNumber]=[]),B[U.noteNumber].push(q));for(const[,U]of Object.entries(B))for(let G=0;G<16;G++)F.push(U.includes(G*T));o.push({pattern:F,selected:!1,index:f})};_e(()=>{const i="drum",f=we[t.difficulty-1].rows,y=he(Re.filter(v=>v.instrument_type===i&&v.n_instruments===f),3);l(c,I(be(y))),l(e,I(y[d(c)].audio_src));for(const[v,h]of y.entries())ee(h.midi_src,v);l(s,!0),se(),l(g,!1),W(S)});function te(i){d(a)!=i&&(l(a,I(i)),o.forEach(f=>{f.selected=f.index===i}))}function re(){l(w,d(c)===d(a)),l(p,!1),l(g,!0),l(u,!0),l(n,!1)}function ne(){const i=d(w)?1e3:0;t.handleNextRound(i),l(u,!1)}function se(){setInterval(()=>{d(p)&&W(E)},1e3)}var O=De(),M=z(O),N=b(M),H=b(N),ae=b(H);{var ie=i=>{var f=pe(),y=z(f);Z(y,17,()=>o,$,(v,h,j)=>{var T=Me(),B=b(T);Fe(B,{get pattern_array(){return d(h).pattern},onmouseup:()=>te(d(h).index),get active(){return d(h).selected},set active(F){d(h).selected=F}}),x(T),k(v,T)}),k(i,f)};J(ae,i=>{d(s)&&i(ie)})}x(H);var A=R(H,2),D=b(A),oe=b(D),ue=le(()=>K+"/audios/pattern_sounds/"+d(e));ge(oe,{get repeats(){return d(S)},get time(){return d(E)},get trackSource(){return d(ue)},get tries(){return C},get volume(){return t.volume},get trackPaused(){return d(g)},set trackPaused(i){l(g,I(i))}}),x(D);var de=R(D,2);xe(de,{style:"mt-3 text-3xl",onmousedown:()=>re(),bgFront:"bg-amber-500",bgBack:"bg-amber-700",children:(i,f)=>{var y=Ne();k(i,y)},$$slots:{default:!0}}),x(A),x(N);var ce=R(N,2);{var me=i=>{var f=He(),y=b(f);Ie(y,{onclick:ne,get GIFButtonTextSuccess(){return t.GIFButtonTextSuccess},get GIFButtonTextFailure(){return t.GIFButtonTextFailure},get volume(){return t.volume},get success(){return d(w)},set success(v){l(w,I(v))},get gifSoundPaused(){return d(n)},set gifSoundPaused(v){l(n,I(v))}}),x(f),k(i,f)};J(ce,i=>{d(u)&&i(me)})}x(M);var V=R(M,2),fe=b(V);Ue(fe,{}),x(V),k(r,O),Y()}export{Ze as P};
