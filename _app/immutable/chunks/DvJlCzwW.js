import{a as T,t as F,c as ge}from"./By-5l90-.js";import{p as ae,t as Y,g as i,r as g,a as ne,b as p,u as Z,f as $,c as D,s as A,d as v,e as Ie}from"./Be9DTLUM.js";import{i as ee}from"./BsFKgJcA.js";import{e as se,i as ie}from"./DCEjmf86.js";import{b as we,p as I}from"./COnAHfzI.js";import{o as ke}from"./DahaPC90.js";import{b as te}from"./CLVV3WwN.js";import{d as Ue}from"./lf1__Oa6.js";import{a as re,B as Be}from"./BVkj_WBF.js";import{g as Pe,a as Se,G as De}from"./DPHXe07w.js";import{M as Te,R as Ee}from"./AWtasrP6.js";function Me(r){var t=new l(r),d=t.readChunk();if(d.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+d.id+"'";for(var m=Ce(d.data),u=[],o=0;!t.eof()&&o<m.numTracks;o++){var e=t.readChunk();if(e.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+e.id+"'";var c=Re(e.data);u.push(c)}return{header:m,tracks:u}}function Ce(r){var t=new l(r),d=t.readUInt16(),m=t.readUInt16(),u={format:d,numTracks:m},o=t.readUInt16();return o&32768?(u.framesPerSecond=256-(o>>8),u.ticksPerFrame=o&255):u.ticksPerBeat=o,u}function Re(r){for(var t=new l(r),d=[];!t.eof();){var m=o();d.push(m)}return d;var u;function o(){var e={};e.deltaTime=t.readVarInt();var c=t.readUInt8();if((c&240)===240)if(c===255){e.meta=!0;var w=t.readUInt8(),a=t.readVarInt();switch(w){case 0:if(e.type="sequenceNumber",a!==2)throw"Expected length for sequenceNumber event is 2, got "+a;return e.number=t.readUInt16(),e;case 1:return e.type="text",e.text=t.readString(a),e;case 2:return e.type="copyrightNotice",e.text=t.readString(a),e;case 3:return e.type="trackName",e.text=t.readString(a),e;case 4:return e.type="instrumentName",e.text=t.readString(a),e;case 5:return e.type="lyrics",e.text=t.readString(a),e;case 6:return e.type="marker",e.text=t.readString(a),e;case 7:return e.type="cuePoint",e.text=t.readString(a),e;case 32:if(e.type="channelPrefix",a!=1)throw"Expected length for channelPrefix event is 1, got "+a;return e.channel=t.readUInt8(),e;case 33:if(e.type="portPrefix",a!=1)throw"Expected length for portPrefix event is 1, got "+a;return e.port=t.readUInt8(),e;case 47:if(e.type="endOfTrack",a!=0)throw"Expected length for endOfTrack event is 0, got "+a;return e;case 81:if(e.type="setTempo",a!=3)throw"Expected length for setTempo event is 3, got "+a;return e.microsecondsPerBeat=t.readUInt24(),e;case 84:if(e.type="smpteOffset",a!=5)throw"Expected length for smpteOffset event is 5, got "+a;var k=t.readUInt8(),E={0:24,32:25,64:29,96:30};return e.frameRate=E[k&96],e.hour=k&31,e.min=t.readUInt8(),e.sec=t.readUInt8(),e.frame=t.readUInt8(),e.subFrame=t.readUInt8(),e;case 88:if(e.type="timeSignature",a!=2&&a!=4)throw"Expected length for timeSignature event is 4 or 2, got "+a;return e.numerator=t.readUInt8(),e.denominator=1<<t.readUInt8(),a===4?(e.metronome=t.readUInt8(),e.thirtyseconds=t.readUInt8()):(e.metronome=36,e.thirtyseconds=8),e;case 89:if(e.type="keySignature",a!=2)throw"Expected length for keySignature event is 2, got "+a;return e.key=t.readInt8(),e.scale=t.readUInt8(),e;case 127:return e.type="sequencerSpecific",e.data=t.readBytes(a),e;default:return e.type="unknownMeta",e.data=t.readBytes(a),e.metatypeByte=w,e}}else if(c==240){e.type="sysEx";var a=t.readVarInt();return e.data=t.readBytes(a),e}else if(c==247){e.type="endSysEx";var a=t.readVarInt();return e.data=t.readBytes(a),e}else throw"Unrecognised MIDI event type byte: "+c;else{var _;if(c&128)_=t.readUInt8(),u=c;else{if(u===null)throw"Running status byte encountered before status byte";_=c,c=u,e.running=!0}var U=c>>4;switch(e.channel=c&15,U){case 8:return e.type="noteOff",e.noteNumber=_,e.velocity=t.readUInt8(),e;case 9:var M=t.readUInt8();return e.type=M===0?"noteOff":"noteOn",e.noteNumber=_,e.velocity=M,M===0&&(e.byte9=!0),e;case 10:return e.type="noteAftertouch",e.noteNumber=_,e.amount=t.readUInt8(),e;case 11:return e.type="controller",e.controllerType=_,e.value=t.readUInt8(),e;case 12:return e.type="programChange",e.programNumber=_,e;case 13:return e.type="channelAftertouch",e.amount=_,e;case 14:return e.type="pitchBend",e.value=_+(t.readUInt8()<<7)-8192,e;default:throw"Unrecognised MIDI event type: "+U}}}}function l(r){this.buffer=r,this.bufferLen=this.buffer.length,this.pos=0}l.prototype.eof=function(){return this.pos>=this.bufferLen};l.prototype.readUInt8=function(){var r=this.buffer[this.pos];return this.pos+=1,r};l.prototype.readInt8=function(){var r=this.readUInt8();return r&128?r-256:r};l.prototype.readUInt16=function(){var r=this.readUInt8(),t=this.readUInt8();return(r<<8)+t};l.prototype.readInt16=function(){var r=this.readUInt16();return r&32768?r-65536:r};l.prototype.readUInt24=function(){var r=this.readUInt8(),t=this.readUInt8(),d=this.readUInt8();return(r<<16)+(t<<8)+d};l.prototype.readInt24=function(){var r=this.readUInt24();return r&8388608?r-16777216:r};l.prototype.readUInt32=function(){var r=this.readUInt8(),t=this.readUInt8(),d=this.readUInt8(),m=this.readUInt8();return(r<<24)+(t<<16)+(d<<8)+m};l.prototype.readBytes=function(r){var t=this.buffer.slice(this.pos,this.pos+r);return this.pos+=r,t};l.prototype.readString=function(r){var t=this.readBytes(r);return String.fromCharCode.apply(null,t)};l.prototype.readVarInt=function(){for(var r=0;!this.eof();){var t=this.readUInt8();if(t&128)r+=t&127,r<<=7;else return r+t}return r};l.prototype.readChunk=function(){var r=this.readString(4),t=this.readUInt32(),d=this.readBytes(t);return{id:r,length:t,data:d}};var Fe=Me,Ne=Fe,He=F("<div></div>"),Oe=F("<button></button>");function Ge(r,t){ae(t,!0);let d=we(t,"active",11,!1);const m=I([]);for(const[o,e]of t.pattern_array.entries())e?o%16<=3||8<=o%16&&o%16<=11?m.push("bg-green-600"):m.push("bg-green-700"):o%16<=3||8<=o%16&&o%16<=11?m.push("bg-gray-300"):m.push("bg-gray-400");var u=Oe();u.__mouseup=function(...o){var e;(e=t.onmouseup)==null||e.apply(this,o)},se(u,21,()=>m,ie,(o,e)=>{var c=He();Y(()=>re(c,`h-full ${i(e)??""} border border-black`)),T(o,c)}),g(u),Y(()=>re(u,` grid h-full w-full grid-cols-16 flex-row border-4 ${(d()?"border-blue-600 shadow-2xl shadow-blue-600 ":"border-gray-500")??""} rounded`)),T(r,u),ne()}Ue(["mouseup"]);const Ae=[{midi_src:"2_Custom2.mid",audio_src:"2_Custom2.wav",instrument_type:"Drum"},{midi_src:"2_Custom3.mid",audio_src:"2_Custom3.wav",instrument_type:"Drum"},{midi_src:"2_Elektro1.mid",audio_src:"2_Elektro 1.wav",instrument_type:"Drum"},{midi_src:"2_Elektro2.mid",audio_src:"2_Elektro 2.wav",instrument_type:"Drum"},{midi_src:"2_HipHop1.mid",audio_src:"2_Hip Hop 1.wav",instrument_type:"Drum"},{midi_src:"2_HipHop2.mid",audio_src:"2_Hip Hop 2.wav",instrument_type:"Drum"},{midi_src:"2_Techno_1.mid",audio_src:"2_Techno 1.wav",instrument_type:"Drum"},{midi_src:"2_Techno_2.mid",audio_src:"2_Techno 2.wav",instrument_type:"Drum"},{midi_src:"3_AmenBreaks.mid",audio_src:"3_Amen Breaks.wav",instrument_type:"Drum"},{midi_src:"3_Custom1.mid",audio_src:"3_Custom 1.wav",instrument_type:"Drum"},{midi_src:"3_Rock1.mid",audio_src:"3_Rock 1.wav",instrument_type:"Drum"},{midi_src:"3_Rumba.mid",audio_src:"3_Rumba.wav",instrument_type:"Drum"},{midi_src:"3_SiberianNights.mid",audio_src:"3_Siberian Nights.wav",instrument_type:"Drum"},{midi_src:"3_SonClave.mid",audio_src:"3_Son Clave.wav",instrument_type:"Drum"},{midi_src:"4_FunkyDrummer.mid",audio_src:"4_Funky Drummer.wav",instrument_type:"Drum"},{midi_src:"4_House1.mid",audio_src:"4_House 1.wav",instrument_type:"Drum"},{midi_src:"4_House2.mid",audio_src:"4_House 2.wav",instrument_type:"Drum"},{midi_src:"4_Rock2.mid",audio_src:"4_Rock 2.wav",instrument_type:"Drum"},{midi_src:"bass_1.mid",audio_src:"bass_1.wav",instrument_type:"Bass"},{midi_src:"bass_2.mid",audio_src:"bass_2.wav",instrument_type:"Bass"},{midi_src:"bass_3.mid",audio_src:"bass_3.wav",instrument_type:"Bass"},{midi_src:"piano_1.mid",audio_src:"piano_1.wav",instrument_type:"Piano"},{midi_src:"piano_2.mid",audio_src:"piano_2.wav",instrument_type:"Piano"},{midi_src:"piano_3.mid",audio_src:"piano_3.wav",instrument_type:"Piano"},{midi_src:"piano_4.mid",audio_src:"piano_4.wav",instrument_type:"Piano"}];var Ve=F('<div class="h-full w-full basis-1/6"><!></div>'),je=F('<p class="px-6 py-3">Raten</p>'),qe=F('<div class="absolute left-0 top-0"><!></div>'),Le=F('<div class="flex size-full justify-between gap-4 rounded-2xl border-x-[7px] border-b-[14px] border-t-[7px] border-b-gray-600 border-l-gray-200 border-r-gray-400 border-t-gray-400 bg-[#d1d5db] p-3 shadow-2xl lg:border-x-[10px] lg:border-b-[20px] lg:border-t-[10px] lg:p-10"><div class="flex basis-9/12 flex-col items-center justify-evenly"><!></div> <div class="flex basis-1/6 flex-col items-center"><div class="h-5/6"><!></div> <!></div> <!></div> <div class="absolute left-6 top-0 m-3 mt-10"><!></div>',1);function rt(r,t){ae(t,!0);const d=I([]);let m=v(0),u=v(-1),o=v(!1),e=v("4_Rock 2.wav"),c=v(!1),w=v(!0),a=v(!1),k=v(!1),E=v(0),_=v(!0),U=v(0),M=0;const oe=async(n,f)=>{const x=await(await fetch(te+"/midis/"+n)).arrayBuffer(),C=new Uint8Array(x),Q=Ne(C),h={};let R=[],N=0,X=0;for(const s of Q.tracks[0])N+=s.deltaTime,s.type==="noteOn"?(s.noteNumber in h||(h[s.noteNumber]=[],X++),h[s.noteNumber].push(N)):s.type==="noteOff"&&h[s.noteNumber].push(N);let B=[],H=1e4,z=0;for(const[,s]of Object.entries(h)){let S=[];for(let b=0;b<s.length;b+=2){let G=s[b+1]-s[b];H=Math.min(H,G),z=Math.max(z,s[b+1]),S.push({start:s[b],len:G})}B.push(S)}let P=z/16;const O=[6,12,24,48,96];if(!O.includes(P)){for(let s=0;s<O.length;s++)if(P<=O[s]){P=O[s];break}}H%P!==0&&(P=H),B=B.reverse(),R=new Array(16*X).fill(!1);for(let s=0;s<B.length;s++)for(let S=0;S<B[s].length;S++){let b=s*16+B[s][S].start/P,G=b+B[s][S].len/P;for(let W=b;W<G;W++)R[W]=!0}M=Math.max(M,R.length),d.push({pattern:R,selected:!1,index:f})};ke(()=>{let n;switch(t.difficulty){case 1:{n="Piano";break}case 2:{n="Bass";break}default:n="Drum"}const f=Pe(Ae.filter(y=>y.instrument_type===n),3);p(m,I(Se(f))),p(e,I(f[i(m)].audio_src));for(const[y,x]of f.entries())oe(x.midi_src,y);p(o,!0),fe(),p(w,!1),Z(U)});function ue(n){i(u)!=n&&(p(u,I(n)),d.forEach(f=>{f.selected=f.index===n}))}function de(){p(k,i(m)===i(u)),p(_,!1),p(w,!0),p(c,!0),p(a,!1)}function ce(){const n=me();t.handleNextRound(n),p(c,!1)}function me(){let n=0;return i(k)&&(n+=1e4,n+=Math.max(-236*i(E)+8e3,2e3*.9^i(E)),n+=Math.max(-1234*i(U)+5e3,2e3*.9^i(U))),n}function fe(){setInterval(()=>{i(_)&&Z(E)},1e3)}var J=Le(),V=$(J),j=D(V),le=D(j);{var pe=n=>{var f=ge(),y=$(f);se(y,17,()=>d,ie,(x,C,Q)=>{var h=Ve(),R=D(h);Ge(R,{get pattern_array(){return i(C).pattern},onmouseup:()=>ue(i(C).index),get active(){return i(C).selected},set active(N){i(C).selected=N}}),g(h),T(x,h)}),T(n,f)};ee(le,n=>{i(o)&&n(pe)})}g(j);var q=A(j,2),L=D(q),_e=D(L),ve=Ie(()=>te+"/audios/pattern_sounds/"+i(e));Te(_e,{get repeats(){return i(U)},get time(){return i(E)},get trackSource(){return i(ve)},get volume(){return t.volume},get trackPaused(){return i(w)},set trackPaused(n){p(w,I(n))}}),g(L);var ye=A(L,2);Be(ye,{bgBack:"bg-amber-700",bgFront:"bg-amber-500",onmousedown:()=>de(),style:"mt-3 text-3xl",children:(n,f)=>{var y=je();T(n,y)},$$slots:{default:!0}}),g(q);var xe=A(q,2);{var he=n=>{var f=qe(),y=D(f);De(y,{onclick:ce,get GIFButtonTextSuccess(){return t.GIFButtonTextSuccess},get GIFButtonTextFailure(){return t.GIFButtonTextFailure},get volume(){return t.volume},get success(){return i(k)},set success(x){p(k,I(x))},get gifSoundPaused(){return i(a)},set gifSoundPaused(x){p(a,I(x))}}),g(f),T(n,f)};ee(xe,n=>{i(c)&&n(he)})}g(V);var K=A(V,2),be=D(K);Ee(be,{}),g(K),T(r,J),ne()}export{rt as P};
