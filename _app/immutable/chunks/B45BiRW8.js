import{a as N,t as F,c as ye}from"./CHkck4dw.js";import{p as te,t as xe,g as u,r as g,a as re,s as p,u as Y,f as Z,c as B,q as z,b as v,d as he}from"./BjWHaepb.js";import{i as $}from"./C6Z4-7cA.js";import{e as ae,i as ne}from"./C6vC90Bg.js";import{b as be,p as I}from"./C6ycZBfC.js";import{o as ge}from"./nRd-gLFk.js";import{b as ee}from"./C3By-Gyw.js";import{d as Ie}from"./IyUyzwpQ.js";import{s as we}from"./Bop7QRR4.js";import{g as ke,a as Ue,R as Pe,G as Se}from"./CuiplVon.js";import{M as De}from"./Cl9yoHdk.js";function Be(r){var t=new l(r),o=t.readChunk();if(o.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+o.id+"'";for(var c=Te(o.data),n=[],d=0;!t.eof()&&d<c.numTracks;d++){var e=t.readChunk();if(e.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+e.id+"'";var m=Ee(e.data);n.push(m)}return{header:c,tracks:n}}function Te(r){var t=new l(r),o=t.readUInt16(),c=t.readUInt16(),n={format:o,numTracks:c},d=t.readUInt16();return d&32768?(n.framesPerSecond=256-(d>>8),n.ticksPerFrame=d&255):n.ticksPerBeat=d,n}function Ee(r){for(var t=new l(r),o=[];!t.eof();){var c=d();o.push(c)}return o;var n;function d(){var e={};e.deltaTime=t.readVarInt();var m=t.readUInt8();if((m&240)===240)if(m===255){e.meta=!0;var w=t.readUInt8(),a=t.readVarInt();switch(w){case 0:if(e.type="sequenceNumber",a!==2)throw"Expected length for sequenceNumber event is 2, got "+a;return e.number=t.readUInt16(),e;case 1:return e.type="text",e.text=t.readString(a),e;case 2:return e.type="copyrightNotice",e.text=t.readString(a),e;case 3:return e.type="trackName",e.text=t.readString(a),e;case 4:return e.type="instrumentName",e.text=t.readString(a),e;case 5:return e.type="lyrics",e.text=t.readString(a),e;case 6:return e.type="marker",e.text=t.readString(a),e;case 7:return e.type="cuePoint",e.text=t.readString(a),e;case 32:if(e.type="channelPrefix",a!=1)throw"Expected length for channelPrefix event is 1, got "+a;return e.channel=t.readUInt8(),e;case 33:if(e.type="portPrefix",a!=1)throw"Expected length for portPrefix event is 1, got "+a;return e.port=t.readUInt8(),e;case 47:if(e.type="endOfTrack",a!=0)throw"Expected length for endOfTrack event is 0, got "+a;return e;case 81:if(e.type="setTempo",a!=3)throw"Expected length for setTempo event is 3, got "+a;return e.microsecondsPerBeat=t.readUInt24(),e;case 84:if(e.type="smpteOffset",a!=5)throw"Expected length for smpteOffset event is 5, got "+a;var k=t.readUInt8(),T={0:24,32:25,64:29,96:30};return e.frameRate=T[k&96],e.hour=k&31,e.min=t.readUInt8(),e.sec=t.readUInt8(),e.frame=t.readUInt8(),e.subFrame=t.readUInt8(),e;case 88:if(e.type="timeSignature",a!=2&&a!=4)throw"Expected length for timeSignature event is 4 or 2, got "+a;return e.numerator=t.readUInt8(),e.denominator=1<<t.readUInt8(),a===4?(e.metronome=t.readUInt8(),e.thirtyseconds=t.readUInt8()):(e.metronome=36,e.thirtyseconds=8),e;case 89:if(e.type="keySignature",a!=2)throw"Expected length for keySignature event is 2, got "+a;return e.key=t.readInt8(),e.scale=t.readUInt8(),e;case 127:return e.type="sequencerSpecific",e.data=t.readBytes(a),e;default:return e.type="unknownMeta",e.data=t.readBytes(a),e.metatypeByte=w,e}}else if(m==240){e.type="sysEx";var a=t.readVarInt();return e.data=t.readBytes(a),e}else if(m==247){e.type="endSysEx";var a=t.readVarInt();return e.data=t.readBytes(a),e}else throw"Unrecognised MIDI event type byte: "+m;else{var _;if(m&128)_=t.readUInt8(),n=m;else{if(n===null)throw"Running status byte encountered before status byte";_=m,m=n,e.running=!0}var U=m>>4;switch(e.channel=m&15,U){case 8:return e.type="noteOff",e.noteNumber=_,e.velocity=t.readUInt8(),e;case 9:var E=t.readUInt8();return e.type=E===0?"noteOff":"noteOn",e.noteNumber=_,e.velocity=E,E===0&&(e.byte9=!0),e;case 10:return e.type="noteAftertouch",e.noteNumber=_,e.amount=t.readUInt8(),e;case 11:return e.type="controller",e.controllerType=_,e.value=t.readUInt8(),e;case 12:return e.type="programChange",e.programNumber=_,e;case 13:return e.type="channelAftertouch",e.amount=_,e;case 14:return e.type="pitchBend",e.value=_+(t.readUInt8()<<7)-8192,e;default:throw"Unrecognised MIDI event type: "+U}}}}function l(r){this.buffer=r,this.bufferLen=this.buffer.length,this.pos=0}l.prototype.eof=function(){return this.pos>=this.bufferLen};l.prototype.readUInt8=function(){var r=this.buffer[this.pos];return this.pos+=1,r};l.prototype.readInt8=function(){var r=this.readUInt8();return r&128?r-256:r};l.prototype.readUInt16=function(){var r=this.readUInt8(),t=this.readUInt8();return(r<<8)+t};l.prototype.readInt16=function(){var r=this.readUInt16();return r&32768?r-65536:r};l.prototype.readUInt24=function(){var r=this.readUInt8(),t=this.readUInt8(),o=this.readUInt8();return(r<<16)+(t<<8)+o};l.prototype.readInt24=function(){var r=this.readUInt24();return r&8388608?r-16777216:r};l.prototype.readUInt32=function(){var r=this.readUInt8(),t=this.readUInt8(),o=this.readUInt8(),c=this.readUInt8();return(r<<24)+(t<<16)+(o<<8)+c};l.prototype.readBytes=function(r){var t=this.buffer.slice(this.pos,this.pos+r);return this.pos+=r,t};l.prototype.readString=function(r){var t=this.readBytes(r);return String.fromCharCode.apply(null,t)};l.prototype.readVarInt=function(){for(var r=0;!this.eof();){var t=this.readUInt8();if(t&128)r+=t&127,r<<=7;else return r+t}return r};l.prototype.readChunk=function(){var r=this.readString(4),t=this.readUInt32(),o=this.readBytes(t);return{id:r,length:t,data:o}};var Me=Be,Ce=Me,Ne=F("<div></div>"),Re=F('<button class=" grid h-full w-full grid-cols-16 flex-row rounded border-4 border-gray-500 hover:ring-blue-500"></button>');function Fe(r,t){te(t,!0),be(t,"active",11,!1);const o=I([]);for(const[n,d]of t.pattern_array.entries())d?n%16<=3||8<=n%16&&n%16<=11?o.push("bg-green-600"):o.push("bg-green-700"):n%16<=3||8<=n%16&&n%16<=11?o.push("bg-gray-300"):o.push("bg-gray-400");var c=Re();c.__mouseup=function(...n){var d;(d=t.onmouseup)==null||d.apply(this,n)},c.__mousedown=function(...n){var d;(d=t.onmousedown)==null||d.apply(this,n)},ae(c,21,()=>o,ne,(n,d)=>{var e=Ne();xe(()=>we(e,`h-full ${u(d)??""} border border-black`)),N(n,e)}),g(c),N(r,c),re()}Ie(["mouseup","mousedown"]);const He=[{midi_src:"2_Custom2.mid",audio_src:"2_Custom2.wav",instrument_type:"Drum"},{midi_src:"2_Custom3.mid",audio_src:"2_Custom3.wav",instrument_type:"Drum"},{midi_src:"2_Elektro1.mid",audio_src:"2_Elektro 1.wav",instrument_type:"Drum"},{midi_src:"2_Elektro2.mid",audio_src:"2_Elektro 2.wav",instrument_type:"Drum"},{midi_src:"2_HipHop1.mid",audio_src:"2_Hip Hop 1.wav",instrument_type:"Drum"},{midi_src:"2_HipHop2.mid",audio_src:"2_Hip Hop 2.wav",instrument_type:"Drum"},{midi_src:"2_Techno_1.mid",audio_src:"2_Techno 1.wav",instrument_type:"Drum"},{midi_src:"2_Techno_2.mid",audio_src:"2_Techno 2.wav",instrument_type:"Drum"},{midi_src:"3_AmenBreaks.mid",audio_src:"3_Amen Breaks.wav",instrument_type:"Drum"},{midi_src:"3_Custom1.mid",audio_src:"3_Custom 1.wav",instrument_type:"Drum"},{midi_src:"3_Rock1.mid",audio_src:"3_Rock 1.wav",instrument_type:"Drum"},{midi_src:"3_Rumba.mid",audio_src:"3_Rumba.wav",instrument_type:"Drum"},{midi_src:"3_SiberianNights.mid",audio_src:"3_Siberian Nights.wav",instrument_type:"Drum"},{midi_src:"3_SonClave.mid",audio_src:"3_Son Clave.wav",instrument_type:"Drum"},{midi_src:"4_FunkyDrummer.mid",audio_src:"4_Funky Drummer.wav",instrument_type:"Drum"},{midi_src:"4_House1.mid",audio_src:"4_House 1.wav",instrument_type:"Drum"},{midi_src:"4_House2.mid",audio_src:"4_House 2.wav",instrument_type:"Drum"},{midi_src:"4_Rock2.mid",audio_src:"4_Rock 2.wav",instrument_type:"Drum"},{midi_src:"bass_1.mid",audio_src:"bass_1.wav",instrument_type:"Bass"},{midi_src:"bass_2.mid",audio_src:"bass_2.wav",instrument_type:"Bass"},{midi_src:"bass_3.mid",audio_src:"bass_3.wav",instrument_type:"Bass"},{midi_src:"piano_1.mid",audio_src:"piano_1.wav",instrument_type:"Piano"},{midi_src:"piano_2.mid",audio_src:"piano_2.wav",instrument_type:"Piano"},{midi_src:"piano_3.mid",audio_src:"piano_3.wav",instrument_type:"Piano"},{midi_src:"piano_4.mid",audio_src:"piano_4.wav",instrument_type:"Piano"}];var Oe=F('<div class="h-full w-full basis-1/6"><!></div>'),Ge=F('<div class="absolute left-0 top-0"><!></div>'),Ae=F('<div class="flex size-full justify-between gap-4 rounded-2xl border-x-[7px] border-b-[14px] border-t-[7px] border-b-gray-600 border-l-gray-200 border-r-gray-400 border-t-gray-400 bg-[#d1d5db] p-3 shadow-2xl lg:border-x-[10px] lg:border-b-[20px] lg:border-t-[10px] lg:p-10"><div class="flex basis-9/12 flex-col items-center justify-evenly"><!></div> <div class="flex basis-1/6 flex-col items-center"><div class="h-5/6"><!></div></div> <!></div> <div class="absolute left-6 top-0 m-3 mt-10"><!></div>',1);function Ze(r,t){te(t,!0);const o=I([]);let c=v(0),n=v(-1),d=v(!1),e=v("4_Rock 2.wav"),m=v(!1),w=v(!0),a=v(!1),k=v(!1),T=v(0),_=v(!0),U=v(0),E=0;const se=async(s,f)=>{const y=await(await fetch(ee+"/midis/"+s)).arrayBuffer(),M=new Uint8Array(y),Q=Ce(M),x={};let C=[],R=0,X=0;for(const i of Q.tracks[0])R+=i.deltaTime,i.type==="noteOn"?(i.noteNumber in x||(x[i.noteNumber]=[],X++),x[i.noteNumber].push(R)):i.type==="noteOff"&&x[i.noteNumber].push(R);let P=[],H=1e4,q=0;for(const[,i]of Object.entries(x)){let D=[];for(let h=0;h<i.length;h+=2){let G=i[h+1]-i[h];H=Math.min(H,G),q=Math.max(q,i[h+1]),D.push({start:i[h],len:G})}P.push(D)}let S=q/16;const O=[6,12,24,48,96];if(!O.includes(S)){for(let i=0;i<O.length;i++)if(S<=O[i]){S=O[i];break}}H%S!==0&&(S=H),P=P.reverse(),C=new Array(16*X).fill(!1);for(let i=0;i<P.length;i++)for(let D=0;D<P[i].length;D++){let h=i*16+P[i][D].start/S,G=h+P[i][D].len/S;for(let L=h;L<G;L++)C[L]=!0}E=Math.max(E,C.length),o.push({pattern:C,selected:!1,index:f})};ge(()=>{let s;switch(t.difficulty){case 1:{s="Piano";break}case 2:{s="Bass";break}default:s="Drum"}const f=ke(He.filter(b=>b.instrument_type===s),3);p(c,I(Ue(f))),p(e,I(f[u(c)].audio_src));for(const[b,y]of f.entries())se(y.midi_src,b);p(d,!0),de(),p(w,!1),Y(U)});function ie(s){u(n)!=s&&(p(n,I(s)),o.forEach(f=>{f.selected=f.index===s}),p(k,u(c)===u(n)),p(_,!1),p(w,!0),p(m,!0),p(a,!1))}function oe(){const s=ue();t.handleNextRound(s),p(m,!1)}function ue(){let s=0;return u(k)&&(s+=1e4,s+=Math.max(-236*u(T)+8e3,2e3*.9^u(T)),s+=Math.max(-1234*u(U)+5e3,2e3*.9^u(U))),s}function de(){setInterval(()=>{u(_)&&Y(T)},1e3)}var W=Ae(),A=Z(W),V=B(A),ce=B(V);{var me=s=>{var f=ye(),b=Z(f);ae(b,17,()=>o,ne,(y,M,Q)=>{var x=Oe(),C=B(x);Fe(C,{get pattern_array(){return u(M).pattern},onmouseup:()=>ie(u(M).index),get active(){return u(M).selected},set active(R){u(M).selected=R}}),g(x),N(y,x)}),N(s,f)};$(ce,s=>{u(d)&&s(me)})}g(V);var j=z(V,2),J=B(j),fe=B(J);const le=he(()=>ee+"/audios/pattern_sounds/"+u(e));De(fe,{get repeats(){return u(U)},get time(){return u(T)},get trackSource(){return u(le)},get volume(){return t.volume},get trackPaused(){return u(w)},set trackPaused(s){p(w,I(s))}}),g(J),g(j);var pe=z(j,2);{var _e=s=>{var f=Ge(),b=B(f);Se(b,{onclick:oe,get GIFButtonTextSuccess(){return t.GIFButtonTextSuccess},get GIFButtonTextFailure(){return t.GIFButtonTextFailure},get volume(){return t.volume},get success(){return u(k)},set success(y){p(k,I(y))},get gifSoundPaused(){return u(a)},set gifSoundPaused(y){p(a,I(y))}}),g(f),N(s,f)};$(pe,s=>{u(m)&&s(_e)})}g(A);var K=z(A,2),ve=B(K);Pe(ve,{}),g(K),N(r,W),re()}export{Ze as P};
